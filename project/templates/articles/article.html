{% extends "base.html" %}
{% block title %}{{ article.title }}{% endblock %}

{% block content %}
<div class="container mt-4">

  <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç–∞—Ç—å–∏ + –∫–Ω–æ–ø–∫–∏ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="mb-0">{{ article.title }}</h1>
    {% if user.is_staff %}
    <div>
      <a href="{% url 'articles:edit' article.slug %}" class="btn btn-warning btn-sm me-2">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
      <button id="delete-article-btn" class="btn btn-danger btn-sm">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
    </div>
    {% endif %}
  </div>

  <p>{{ article.content|linebreaks }}</p>

  <hr>

  <!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ -->
  <h4 class="mt-4">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h4>

  {% if user.is_authenticated %}
    <form id="comment-form">
      {% csrf_token %}
      <div class="mb-3">
        <textarea id="comment-text" name="text" class="form-control" rows="3" placeholder="–í–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"></textarea>
      </div>
      <button type="submit" class="btn btn-success">üí¨ –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </form>
  {% else %}
    <p><a href="{% url 'users:login' %}">–í–æ–π–¥–∏—Ç–µ</a>, —á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π.</p>
  {% endif %}

  <div id="comments-container" class="mt-4">
    {% include "articles/comments.html" %}
  </div>

</div>

<style>
#comments-container {
  background-color:#fff;
  border:1px solid #ddd;
  border-radius:8px;
  padding:16px;
  box-shadow:0 2px 6px rgba(0,0,0,0.05);
}
.comment {
  border-left:4px solid #28a745;
  padding:12px;
  margin-bottom:1rem;
  background-color:#f9f9f9;
  border-radius:6px;
  transition:background-color 0.2s ease;
}
.comment:hover { background-color:#f1f8f4; }
.comment small { color:#666; }
textarea.form-control { resize: vertical; }
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

  // --- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è —á–µ—Ä–µ–∑ AJAX ---
  const commentForm = document.getElementById('comment-form');
  if(commentForm){
    commentForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const text = document.getElementById('comment-text').value.trim();
      if(!text) return;

      const url = "{% url 'articles:comment_create' article.slug %}";
      const response = await fetch(url, {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrftoken,
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: new URLSearchParams({ text })
      });

      if(response.ok){
        const html = await response.text();
        document.getElementById('comments-container').innerHTML = html;
        document.getElementById('comment-text').value = '';
        attachDeleteCommentHandlers(); // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ —É–¥–∞–ª–µ–Ω–∏—è
      }
    });
  }

  // --- –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—å–∏ —á–µ—Ä–µ–∑ JS confirm ---
  const deleteBtn = document.getElementById('delete-article-btn');
  if(deleteBtn){
    deleteBtn.addEventListener('click', async () => {
      if(!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É —Å—Ç–∞—Ç—å—é?')){
        return;
      }

      const url = "{% url 'articles:delete' article.slug %}";
      const response = await fetch(url, {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrftoken,
          'X-Requested-With': 'XMLHttpRequest'
        }
      });

      if(response.ok){
        window.location.href = "{% url 'articles:articles' %}";
      } else {
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—å–∏!');
      }
    });
  }

  // --- –£–¥–∞–ª–µ–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ —á–µ—Ä–µ–∑ AJAX ---
  function attachDeleteCommentHandlers(){
    const deleteButtons = document.querySelectorAll('.delete-comment-btn');
    deleteButtons.forEach(btn => {
      btn.removeEventListener('click', btn.clickHandler); // –∏–∑–±–µ–≥–∞–µ–º –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
      btn.clickHandler = async function(e){
        e.preventDefault();
        if(!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π?')) return;

        const url = btn.dataset.url;
        const response = await fetch(url, {
          method: 'POST',
          headers: {
            'X-CSRFToken': csrftoken,
            'X-Requested-With': 'XMLHttpRequest'
          }
        });

        if(response.ok){
          const html = await response.text();
          document.getElementById('comments-container').innerHTML = html;
          attachDeleteCommentHandlers(); // –ø–æ–≤—Ç–æ—Ä–Ω–æ –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è HTML
        } else {
          alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è!');
        }
      };
      btn.addEventListener('click', btn.clickHandler);
    });
  }

  attachDeleteCommentHandlers(); // –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
});
</script>
{% endblock %}
