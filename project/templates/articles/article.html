{% extends "base.html" %}
{% block title %}{{ article.title }}{% endblock %}

{% block content %}
<div class="container mt-4">

  <h1 class="mb-3">{{ article.title }}</h1>
  <p>{{ article.content|linebreaks }}</p>

  <hr>

  <h4 class="mt-4">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h4>

  {% if user.is_authenticated %}
    <form id="comment-form" method="post" data-article="{{ article.slug }}">
      {% csrf_token %}
      <div class="mb-3">
        <textarea id="comment-text" name="text" class="form-control" rows="3" placeholder="–í–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"></textarea>
      </div>
      <button type="submit" class="btn btn-success">üí¨ –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </form>
  {% else %}
    <p><a href="{% url 'users:login' %}">–í–æ–π–¥–∏—Ç–µ</a>, —á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π.</p>
  {% endif %}

  <div id="comments-container" class="mt-4">
    {% include "articles/comments.html" %}
  </div>

</div>

<style>
.comment {
  border-left: 3px solid #28a745;
  padding-left: 12px;
  margin-bottom: 1rem;
}
.reply {
  margin-left: 1.5rem;
  border-left: 2px solid #ccc;
  padding-left: 10px;
}
.comment small {
  color: #666;
}
.comment .reply-btn {
  font-size: 0.9rem;
  color: #007bff;
  cursor: pointer;
}
.comment .reply-btn:hover {
  text-decoration: underline;
}
.reply-form {
  margin-top: 8px;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

  // --- –û—Å–Ω–æ–≤–Ω–∞—è —Ñ–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è ---
  const commentForm = document.getElementById('comment-form');
  if (commentForm) {
    commentForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const text = document.getElementById('comment-text').value.trim();
      if (!text) return;

      const response = await fetch(commentForm.dataset.article + '/comment/', {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrftoken,
          'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: new URLSearchParams({ text })
      });

      if (response.ok) {
        const html = await response.text();
        document.getElementById('comments-container').innerHTML = html;
        document.getElementById('comment-text').value = '';
      }
    });
  }

  // --- –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–ª–∏–∫–æ–≤ –Ω–∞ –∫–Ω–æ–ø–∫–∏ "–û—Ç–≤–µ—Ç–∏—Ç—å" ---
  document.body.addEventListener('click', (e) => {
    if (e.target.classList.contains('reply-btn')) {
      const commentId = e.target.dataset.comment;
      toggleReplyForm(commentId);
    }
  });

  // --- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã –æ—Ç–≤–µ—Ç–∞ ---
  document.body.addEventListener('submit', async (e) => {
    if (e.target.classList.contains('reply-form')) {
      e.preventDefault();

      const form = e.target;
      const text = form.querySelector('textarea').value.trim();
      const parentId = form.querySelector('[name=parent_id]').value;
      if (!text) return;

      const response = await fetch(form.action, {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrftoken,
          'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: new URLSearchParams({ text, parent_id: parentId })
      });

      if (response.ok) {
        const html = await response.text();
        document.getElementById('comments-container').innerHTML = html;
      }
    }
  });

  // --- –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è / –∑–∞–∫—Ä—ã—Ç–∏—è —Ñ–æ—Ä–º—ã –æ—Ç–≤–µ—Ç–∞ ---
  function toggleReplyForm(commentId) {
    const container = document.getElementById('reply-container-' + commentId);
    if (container.innerHTML.trim()) {
      container.innerHTML = ''; // —Å–∫—Ä—ã—Ç—å
      return;
    }
    container.innerHTML = `
      <form method="post" action="${window.location.pathname}comment/" class="reply-form">
        <input type="hidden" name="csrfmiddlewaretoken" value="${csrftoken}">
        <input type="hidden" name="parent_id" value="${commentId}">
        <div class="input-group mt-2">
          <textarea name="text" class="form-control" rows="1" placeholder="–í–∞—à –æ—Ç–≤–µ—Ç..."></textarea>
          <button type="submit" class="btn btn-outline-success">‚Ü©Ô∏è</button>
        </div>
      </form>
    `;
  }
});
</script>
{% endblock %}
