{% extends "base.html" %}
{% block title %}{{ article.title }}{% endblock %}

{% block content %}
<div class="container mt-4">
  <h1 class="mb-3">{{ article.title }}</h1>
  <p>{{ article.content|linebreaks }}</p>

  <hr>

  <h4 class="mt-4">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h4>

  {% if user.is_authenticated %}
    <form id="comment-form">
      {% csrf_token %}
      <div class="mb-3">
        <textarea id="comment-text" name="text" class="form-control" rows="3" placeholder="–í–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"></textarea>
      </div>
      <button type="submit" class="btn btn-success">üí¨ –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </form>
  {% else %}
    <p><a href="{% url 'users:login' %}">–í–æ–π–¥–∏—Ç–µ</a>, —á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π.</p>
  {% endif %}

  <div id="comments-container" class="mt-4">
    {% include "articles/comments.html" %}
  </div>
</div>

<style>
#comments-container { background-color:#fff; border:1px solid #ddd; border-radius:8px; padding:16px; box-shadow:0 2px 6px rgba(0,0,0,0.05);}
.comment { border-left:4px solid #28a745; padding:12px; margin-bottom:1rem; background-color:#f9f9f9; border-radius:6px; transition:background-color 0.2s ease;}
.comment:hover { background-color:#f1f8f4; }
.comment small { color:#666; }
textarea.form-control { resize: vertical; }
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
  const commentForm = document.getElementById('comment-form');

  if(commentForm){
    commentForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const text = document.getElementById('comment-text').value.trim();
      if(!text) return;

      const url = "{% url 'articles:comment_create' article.slug %}";
      const response = await fetch(url, {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrftoken,
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: new URLSearchParams({ text })
      });

      if(response.ok){
        const html = await response.text();
        document.getElementById('comments-container').innerHTML = html;
        document.getElementById('comment-text').value = '';
      }
    });
  }
});
</script>
{% endblock %}
