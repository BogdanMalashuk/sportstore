{% extends "base.html" %}
{% block title %}{{ product.name }} ‚Äî SportStore{% endblock %}

{% block content %}
<div class="container product-page my-5">
  <div class="row g-4">
    <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ -->
    <div class="col-lg-6 text-center">
      {% if product.image %}
        <img src="{{ product.image }}" alt="{{ product.name }}" class="img-fluid rounded shadow-sm">
      {% else %}
        <img src="https://via.placeholder.com/600x400?text=No+Image" alt="{{ product.name }}" class="img-fluid rounded shadow-sm">
      {% endif %}
    </div>

    <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ -->
    <div class="col-lg-6">
      <div class="product-info-card">
        <h1 class="fw-bold">{{ product.name }}</h1>
        <p class="text-muted mb-1">{{ product.category.name }}</p>
        <p class="fs-4 fw-bold text-success">{{ product.price }} ‚ÇΩ</p>
        <p>–í –Ω–∞–ª–∏—á–∏–∏: <strong>{{ product.stock }}</strong></p>
        <hr>
        <p>{{ product.description }}</p>

        {% if user.is_staff %}
          <div class="d-flex gap-2 mt-3">
            <a href="{% url 'shop:product_edit' product.pk %}" class="btn btn-warning w-50">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
            <a href="{% url 'shop:product_delete' product.pk %}" class="btn btn-danger w-50">üóë –£–¥–∞–ª–∏—Ç—å</a>
          </div>
        {% elif user.is_authenticated %}
          <button id="cart-toggle-btn" class="btn {% if in_cart %}btn-danger{% else %}btn-success{% endif %} w-100 mt-3" data-product-id="{{ product.id }}">
            {% if in_cart %}–£–¥–∞–ª–∏—Ç—å –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã{% else %}üõí –í –∫–æ—Ä–∑–∏–Ω—É{% endif %}
          </button>
        {% else %}
          <a href="{% url 'users:login' %}" class="btn btn-success w-100 mt-3">–í–æ–π—Ç–∏ –¥–ª—è –ø–æ–∫—É–ø–∫–∏</a>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- –ë–ª–æ–∫ –æ—Ç–∑—ã–≤–æ–≤ -->
  <section class="mt-5">
    <h3 class="mb-4">–û—Ç–∑—ã–≤—ã</h3>

    <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ—Ç–∑—ã–≤–∞ -->
    {% if can_review %}
      <div class="review-card mb-4 p-3" id="review-form-card">
        <form id="review-form" method="post">
          {% csrf_token %}
          <div class="mb-2">
            {{ form.text }}
          </div>
          <div class="mb-2">
            <!-- –ó–≤—ë–∑–¥–Ω—ã–π —Ä–µ–π—Ç–∏–Ω–≥ -->
            <div class="star-rating" id="star-rating">
              {% for i in "12345" %}
                <span class="star" data-value="{{ forloop.counter }}">‚òÖ</span>
              {% endfor %}
              <input type="hidden" name="rating" id="rating-input" value="0">
            </div>
          </div>
          <button type="submit" class="btn btn-success mt-2">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</button>
        </form>
      </div>
    {% else %}
      {% if user.is_authenticated %}
        <p class="text-muted">–í—ã –º–æ–∂–µ—Ç–µ –æ—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤ –ø–æ—Å–ª–µ –ø–æ–∫—É–ø–∫–∏ —ç—Ç–æ–≥–æ —Ç–æ–≤–∞—Ä–∞.</p>
      {% else %}
        <p class="text-muted">–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤.</p>
      {% endif %}
    {% endif %}

    <div class="row g-3" id="reviews-list">
      {% for r in reviews %}
        <div class="col-md-6">
          <div class="review-card h-100 p-3">
            <div class="d-flex justify-content-between mb-2">
              <strong>{{ r.user.username }}</strong>
              <span class="text-warning">
                {% for i in "12345" %}
                  {% if forloop.counter <= r.rating %}‚òÖ{% else %}‚òÜ{% endif %}
                {% endfor %}
              </span>
            </div>
            <p>{{ r.text }}</p>
            <small class="text-muted">{{ r.created_at|date:"d.m.Y H:i" }}</small>
          </div>
        </div>
      {% empty %}
        <p class="text-muted">–ü–æ–∫–∞ –Ω–µ—Ç –æ—Ç–∑—ã–≤–æ–≤.</p>
      {% endfor %}
    </div>
  </section>
</div>

<style>
.product-page { padding: 3rem 0; }
.product-info-card {
  background-color: #ffffff; border-radius: 10px; padding: 2rem;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}
.product-info-card:hover { box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15); }
.product-page img { max-height: 400px; width: 100%; object-fit: contain; border-radius: 10px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05); transition: transform 0.2s ease; }
.product-info-card h1 { font-weight: 700; margin-bottom: 0.5rem; }
.product-info-card p.text-muted { font-size: 0.95rem; margin-bottom: 1rem; }
.product-info-card p.fs-4 { margin-bottom: 1rem; }
.product-info-card .btn { border-radius: 8px; font-weight: 500; transition: all 0.2s ease; }
.product-info-card .btn-success:hover { background-color: #ff6330; border-color: #ff6330; }
.product-info-card .btn-danger:hover { background-color: #cc2e00; border-color: #cc2e00; }
.product-info-card .btn-warning:hover { background-color: #e6b800; border-color: #e6b800; }

.product-page section h3 { margin-bottom: 1.5rem; }
.product-page .review-card {
  background-color: #ffffff; border-radius: 10px; padding: 1rem;
  box-shadow: 0 3px 10px rgba(0,0,0,0.05);
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}
.product-page .review-card:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
.product-page .review-card .text-warning { font-weight: 600; letter-spacing: 2px; }
.product-page .review-card small { font-size: 0.8rem; color: #6c757d; }
.star-rating { font-size: 1.5rem; display: inline-block; }
.star-rating .star { cursor: pointer; color: #ccc; transition: color 0.2s; margin-right: 2px; }
.star-rating .star.filled { color: #ffcc00; }
.product-page .review-card form input,
.product-page .review-card form textarea { width: 100%; padding: 0.5rem; border-radius: 6px; border: 1px solid #ced4da; margin-bottom: 0.5rem; font-size: 0.95rem; }
.product-page .review-card form button { border-radius: 6px; }
.product-page .fw-bold { font-weight: 600; }
.product-page .text-success { color: #28a745 !important; }
</style>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
  const btn = document.getElementById('cart-toggle-btn');
  if (btn) {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      const productId = this.dataset.productId;
      const csrftoken = getCookie('csrftoken');
      fetch(`/cart/toggle/${productId}/`, {
        method: 'POST',
        headers: { 'X-CSRFToken': csrftoken, 'Content-Type': 'application/json' },
        body: JSON.stringify({})
      })
      .then(res => res.json())
      .then(data => {
        if (data.error) return;
        const cartCount = document.getElementById('cart-count');
        if (cartCount) cartCount.innerText = data.cart_item_count > 0 ? `(${data.cart_item_count})` : '';
        if (data.action === 'added') { btn.classList.replace('btn-success', 'btn-danger'); btn.textContent = '–£–¥–∞–ª–∏—Ç—å –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã'; }
        else if (data.action === 'removed') { btn.classList.replace('btn-danger', 'btn-success'); btn.textContent = 'üõí –í –∫–æ—Ä–∑–∏–Ω—É'; }
      }).catch(err => console.error(err));
    });
  }

  // --- –ó–≤—ë–∑–¥–Ω—ã–π —Ä–µ–π—Ç–∏–Ω–≥ ---
  const stars = document.querySelectorAll('#star-rating .star');
  const ratingInput = document.getElementById('rating-input');
  let selectedRating = 0;
  stars.forEach((star, index) => {
    star.addEventListener('mouseover', () => { stars.forEach((s,i) => s.classList.toggle('filled', i <= index)); });
    star.addEventListener('mouseout', () => { stars.forEach((s,i) => s.classList.toggle('filled', i < selectedRating)); });
    star.addEventListener('click', () => { selectedRating = index + 1; ratingInput.value = selectedRating; stars.forEach((s,i) => s.classList.toggle('filled', i < selectedRating)); });
  });

  // --- AJAX –æ—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–∑—ã–≤–∞ ---
  const reviewForm = document.getElementById('review-form');
  if (reviewForm) {
    reviewForm.addEventListener('submit', function(e) {
      e.preventDefault();
      const csrftoken = getCookie('csrftoken');
      const text = this.querySelector('textarea[name="text"]').value;
      const rating = parseInt(ratingInput.value);
      const productId = "{{ product.id }}";

      fetch(`/reviews/add/${productId}/`, {
        method: 'POST',
        headers: { 'X-CSRFToken': csrftoken, 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
        body: JSON.stringify({ text, rating })
      })
      .then(res => res.json())
      .then(data => {
        if (!data.success) return;

        // —Å–∫—Ä—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
        document.getElementById('review-form-card').style.display = 'none';

        // —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π –æ—Ç–∑—ã–≤ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –∑–≤—ë–∑–¥–∞–º–∏
        const reviewsList = document.getElementById('reviews-list');
        const colDiv = document.createElement('div');
        colDiv.classList.add('col-md-6');

        const reviewDiv = document.createElement('div');
        reviewDiv.classList.add('review-card', 'h-100', 'p-3');

        // –≤–µ—Ä—Ö–Ω–∏–π –±–ª–æ–∫ —Å —é–∑–µ—Ä–æ–º –∏ –∑–≤—ë–∑–¥–∞–º–∏
        const topDiv = document.createElement('div');
        topDiv.classList.add('d-flex', 'justify-content-between', 'mb-2');

        const usernameStrong = document.createElement('strong');
        usernameStrong.textContent = data.username;

        const starsSpan = document.createElement('span');
        starsSpan.classList.add('text-warning');
        for (let i = 1; i <= 5; i++) {
          const star = document.createElement('span');
          star.classList.add('star');
          star.textContent = i <= data.rating ? '‚òÖ' : '‚òÜ';
          starsSpan.appendChild(star);
        }

        topDiv.appendChild(usernameStrong);
        topDiv.appendChild(starsSpan);

        const textP = document.createElement('p');
        textP.textContent = data.text;

        const createdSmall = document.createElement('small');
        createdSmall.classList.add('text-muted');
        createdSmall.textContent = data.created_at;

        reviewDiv.appendChild(topDiv);
        reviewDiv.appendChild(textP);
        reviewDiv.appendChild(createdSmall);

        colDiv.appendChild(reviewDiv);
        reviewsList.prepend(colDiv);
      })
      .catch(err => console.error(err));
    });
  }
});

// --- CSRF ---
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    document.cookie.split(';').forEach(cookie => {
      cookie = cookie.trim();
      if (cookie.startsWith(name + '=')) cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
    });
  }
  return cookieValue;
}
</script>
{% endblock %}
