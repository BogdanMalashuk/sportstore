{% extends "base.html" %}
{% block title %}{{ product.name }} ‚Äî SportStore{% endblock %}

{% block content %}
<div class="container my-5">
  <div class="row g-4">
    <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ -->
    <div class="col-lg-6 text-center">
      {% if product.image %}
        <img src="{{ product.image }}" alt="{{ product.name }}" class="img-fluid rounded shadow-sm">
      {% else %}
        <img src="https://via.placeholder.com/600x400?text=No+Image" class="img-fluid rounded shadow-sm">
      {% endif %}
    </div>

    <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ -->
    <div class="col-lg-6">
      <div class="product-info-card p-4 bg-white rounded shadow-sm">
        <h1 class="fw-bold">{{ product.name }}</h1>
        <p class="text-muted mb-1">{{ product.category.name }}</p>
        <p class="fs-4 fw-bold text-success">{{ product.price }} ‚ÇΩ</p>
        <p>–í –Ω–∞–ª–∏—á–∏–∏: <strong>{{ product.stock }}</strong></p>
        <hr>
        <p>{{ product.description }}</p>

        {% if user.is_staff %}
          <div class="d-flex gap-2 mt-3">
            <a href="{% url 'shop:product_edit' product.pk %}" class="btn btn-warning w-50">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
            <a href="{% url 'shop:product_delete' product.pk %}" class="btn btn-danger w-50">üóë –£–¥–∞–ª–∏—Ç—å</a>
          </div>
        {% elif user.is_authenticated %}
          <button
            id="cart-toggle-btn"
            class="btn {% if in_cart %}btn-danger{% else %}btn-success{% endif %} w-100 mt-3"
            data-product-id="{{ product.id }}">
            {% if in_cart %}–£–¥–∞–ª–∏—Ç—å –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã{% else %}üõí –í –∫–æ—Ä–∑–∏–Ω—É{% endif %}
          </button>
        {% else %}
          <a href="{% url 'users:login' %}" class="btn btn-success w-100 mt-3">–í–æ–π—Ç–∏ –¥–ª—è –ø–æ–∫—É–ø–∫–∏</a>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- –ë–ª–æ–∫ –æ—Ç–∑—ã–≤–æ–≤ -->
  <section class="mt-5">
    <h3 class="mb-4">–û—Ç–∑—ã–≤—ã</h3>

    <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ—Ç–∑—ã–≤–∞ -->
    {% if can_review %}
      <div class="card p-3 mb-4 shadow-sm">
        <form method="post">
          {% csrf_token %}
          <div class="mb-2">
            {{ form.text }}
          </div>
          <div class="mb-2">
            {{ form.rating }}
          </div>
          <button type="submit" class="btn btn-success">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</button>
        </form>
      </div>
    {% else %}
      {% if user.is_authenticated %}
        <p class="text-muted">–í—ã –º–æ–∂–µ—Ç–µ –æ—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤ –ø–æ—Å–ª–µ –ø–æ–∫—É–ø–∫–∏ —ç—Ç–æ–≥–æ —Ç–æ–≤–∞—Ä–∞.</p>
      {% else %}
        <p class="text-muted">–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤.</p>
      {% endif %}
    {% endif %}

    <div class="row g-3">
      {% for r in reviews %}
        <div class="col-md-6">
          <div class="card h-100 shadow-sm">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <strong>{{ r.user.username }}</strong>
                <span class="text-warning">{{ r.rating }}/5 ‚òÖ</span>
              </div>
              <p>{{ r.text }}</p>
              <small class="text-muted">{{ r.created_at|date:"d.m.Y H:i" }}</small>
            </div>
          </div>
        </div>
      {% empty %}
        <p class="text-muted">–ü–æ–∫–∞ –Ω–µ—Ç –æ—Ç–∑—ã–≤–æ–≤.</p>
      {% endfor %}
    </div>
  </section>
</div>

<style>
  .product-info-card {
    border: 1px solid #e0e0e0;
    transition: transform 0.2s, box-shadow 0.2s;
  }

  .product-info-card:hover {
    box-shadow: 0 8px 20px rgba(0,0,0,0.15);
  }

  .img-fluid {
    max-height: 500px;
    object-fit: contain;
  }

  /* –§–æ—Ä–º–∞ –æ—Ç–∑—ã–≤–∞ */
  .card form input, .card form textarea, .card form select {
    width: 100%;
    padding: 0.5rem;
    border: 1px solid #ced4da;
    border-radius: 6px;
  }
</style>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
  const btn = document.getElementById('cart-toggle-btn');
  if (!btn) return;

  btn.addEventListener('click', function (e) {
    e.preventDefault();
    const productId = this.dataset.productId;
    const csrftoken = getCookie('csrftoken');

    fetch(`/cart/toggle/${productId}/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrftoken,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({})
    })
    .then(res => res.json())
    .then(data => {
      if (data.error) return;
      const cartCount = document.getElementById('cart-count');
      if (cartCount) {
        cartCount.innerText = data.cart_item_count > 0 ? `(${data.cart_item_count})` : '';
      }

      if (data.action === 'added') {
        btn.classList.remove('btn-success');
        btn.classList.add('btn-danger');
        btn.textContent = '–£–¥–∞–ª–∏—Ç—å –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã';
      } else if (data.action === 'removed') {
        btn.classList.remove('btn-danger');
        btn.classList.add('btn-success');
        btn.textContent = 'üõí –í –∫–æ—Ä–∑–∏–Ω—É';
      }
    })
    .catch(err => console.error(err));
  });
});
</script>
{% endblock %}
